create or replace view test_dbt.stg_customer
  
  as
    

-- Generated by dbtvault.



WITH source_data AS (

    SELECT

    CUSTOMER_ID,
    FIRST_NAME,
    LAST_NAME,
    EMAIL

    FROM test_dbt.raw_customer
),

derived_columns AS (

    SELECT

    CUSTOMER_ID,
    FIRST_NAME,
    LAST_NAME,
    EMAIL,
    'SAP' AS RECORD_SRC

    FROM source_data
),

hashed_columns AS (

    SELECT

    CUSTOMER_ID,
    FIRST_NAME,
    LAST_NAME,
    EMAIL,
    RECORD_SRC,

    CAST((MD5_BINARY(NULLIF(UPPER(TRIM(CAST(CUSTOMER_ID AS VARCHAR))), ''))) AS BINARY(16)) AS CUSTOMER_HK,
    CAST(MD5_BINARY(CONCAT_WS('||',
        IFNULL(NULLIF(UPPER(TRIM(CAST(EMAIL AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST(FIRST_NAME AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST(LAST_NAME AS VARCHAR))), ''), '^^')
    )) AS BINARY(16)) AS CUSTOMER_HASHDIFF

    FROM derived_columns
),

columns_to_select AS (

    SELECT

    CUSTOMER_ID,
    FIRST_NAME,
    LAST_NAME,
    EMAIL,
    RECORD_SRC,
    CUSTOMER_HK,
    CUSTOMER_HASHDIFF

    FROM hashed_columns
)

SELECT * FROM columns_to_select
