create or replace view test_dbt.sat_order
  
  as
    

-- Generated by dbtvault.



WITH source_data AS (

    SELECT

    ORDER_ID,
    ORDER_DATE,
    CUSTOMER_ID,
    PRODUCT_ID,
    QTY,
    ORDER_AMT,
    RECORD_SOURCE,
    LOAD_DATETIME,
    ORDER_HK,
    CUSTOMER_HK,
    PRODUCT_HK,
    ORDER_HASHDIFF,
    ORDER_PRODUCT_HASHDIFF

    FROM test_dbt.stg_order_product
),

derived_columns AS (

    SELECT

    ORDER_ID,
    ORDER_DATE,
    CUSTOMER_ID,
    PRODUCT_ID,
    QTY,
    ORDER_AMT,
    ORDER_HK,
    CUSTOMER_HK,
    PRODUCT_HK,
    ORDER_HASHDIFF,
    ORDER_PRODUCT_HASHDIFF,
    '1SAP' AS RECORD_SOURCE,
    CURRENT_TIMESTAMP() AS LOAD_DATETIME

    FROM source_data
),

hashed_columns AS (

    SELECT

    ORDER_ID,
    ORDER_DATE,
    CUSTOMER_ID,
    PRODUCT_ID,
    QTY,
    ORDER_AMT,
    RECORD_SOURCE,
    LOAD_DATETIME,
    CUSTOMER_HK,
    PRODUCT_HK,
    ORDER_PRODUCT_HASHDIFF,

    SHA2(NULLIF(UPPER(TRIM(CAST(ORDER_ID AS STRING))), ''), 256) AS ORDER_HK,
    SHA2(CONCAT_WS('||',
        IFNULL(NULLIF(UPPER(TRIM(CAST(ORDER_DATE AS STRING))), ''), '^^')
    ), 256) AS ORDER_HASHDIFF

    FROM derived_columns
),

columns_to_select AS (

    SELECT

    ORDER_ID,
    ORDER_DATE,
    CUSTOMER_ID,
    PRODUCT_ID,
    QTY,
    ORDER_AMT,
    CUSTOMER_HK,
    PRODUCT_HK,
    ORDER_PRODUCT_HASHDIFF,
    RECORD_SOURCE,
    LOAD_DATETIME,
    ORDER_HK,
    ORDER_HASHDIFF

    FROM hashed_columns
)

SELECT * FROM columns_to_select
