

-- Generated by dbtvault.



WITH source_data AS (

    SELECT

    CUSTOMER_ID,
    FIRST_NAME,
    LAST_NAME,
    EMAIL

    FROM test_dbt.raw_customer
),

derived_columns AS (

    SELECT

    CUSTOMER_ID,
    FIRST_NAME,
    LAST_NAME,
    EMAIL,
    'SAP' AS RECORD_SOURCE,
    2022-03-23T01:51:48.163+0000 AS LOAD_DATETIME

    FROM source_data
),

hashed_columns AS (

    SELECT

    CUSTOMER_ID,
    FIRST_NAME,
    LAST_NAME,
    EMAIL,
    RECORD_SOURCE,
    LOAD_DATETIME,

    CAST((MD5_BINARY(NULLIF(UPPER(TRIM(CAST(CUSTOMER_ID AS VARCHAR))), ''))) AS BINARY(16)) AS CUSTOMER_HK,
    CAST(MD5_BINARY(CONCAT_WS('||',
        IFNULL(NULLIF(UPPER(TRIM(CAST(EMAIL AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST(FIRST_NAME AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST(LAST_NAME AS VARCHAR))), ''), '^^')
    )) AS BINARY(16)) AS CUSTOMER_HASHDIFF

    FROM derived_columns
),

columns_to_select AS (

    SELECT

    CUSTOMER_ID,
    FIRST_NAME,
    LAST_NAME,
    EMAIL,
    RECORD_SOURCE,
    LOAD_DATETIME,
    CUSTOMER_HK,
    CUSTOMER_HASHDIFF

    FROM hashed_columns
)

SELECT * FROM columns_to_select